(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function _iterableToArrayLimit(t,e){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var n,i,o=[],a=!0,s=!1;try{for(r=r.call(t);!(a=(n=r.next()).done)&&(o.push(n.value),!e||o.length!==e);a=!0);}catch(t){s=!0,i=t}finally{try{a||null==r.return||r.return()}finally{if(s)throw i}}return o}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function asyncGeneratorStep(t,e,r,n,i,o,a){try{var s=t[o](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,i)}function _asyncToGenerator(t){return function(){var e=this,r=arguments;return new Promise(function(n,i){var o=t.apply(e,r);function a(t){asyncGeneratorStep(o,n,i,a,s,"next",t)}function s(t){asyncGeneratorStep(o,n,i,a,s,"throw",t)}a(void 0)})}}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}!function(){var t=function(){function t(t,e){this.parentId=t,this.nmId=e,this.isReady=!1,this.hideChart=!0,this.marker=null,this.onColorChanged=this.onColorChanged.bind(this)}var e=t.prototype;return e.init=function(){return this._bindEvents(),this},e.destroy=function(){this._unbindEvents()},e.onColorChanged=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var r,n,i,o,a,s,c;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(i=e.detail,o=i.sourceId,a=i.sourceNmId,s=i.selectedNomenclature,o==this.parentId&&a==this.nmId){t.next=3;break}return t.abrupt("return");case 3:return this.nmId=s.nmId,null===(r=this.marker)||void 0===r||r.dispatchEvent(new CustomEvent("Unshown")),null===(n=this.marker)||void 0===n||n.remove(),t.next=8,this.$services.productCard.loadPriceHistory(this.nmId);case 8:c=t.sent,this.showChartAsync(c,{currentPrice:s.price.salePrice});case 10:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}(),e.renderChartAsync=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var r,n,i,o,a,s,c;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,null!=e){t.next=3;break}return t.abrupt("return");case 3:return n="classList"in SVGElement.prototype?Promise.resolve():this.$moduleLoader.loadModuleAsync("svgElementClassListPolyfill",!0),t.next=6,Promise.all([this.$getCurrentXInfoAsync(),n]);case 6:i=t.sent,o=_slicedToArray(i,1),a=o[0],s=parseFloat(null!==(r=new URLSearchParams(a).get("pricemarginCoeff"))&&void 0!==r?r:1),c=this._buildPoints(e,s),this.settings=this._getSettings(c),this.charPoint=this._createCharPoints(c,this.settings),this.dashedVerticalBarsCoords=this._createDashedBars(),this.chartPath=this._buildCharPath(),$.observable(this).setProperty({isReady:!0}),t.next=21;break;case 18:t.prev=18,t.t0=t.catch(0),console.error(t.t0);case 21:case"end":return t.stop()}},t,this,[[0,18]])}));return function(e){return t.apply(this,arguments)}}(),e.showChartAsync=function(t){var e=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).currentPrice;if(this.marker=null,$.observable(this).setProperty({isReady:!1}),this.chartEnable&&Array.isArray(t)&&(t.length>=2||e>0&&t.length>=1)){if(t.sort(function(t,e){return t.dt-e.dt}),t.forEach(function(t){var e,r;null!==(e=t.price)&&void 0!==e&&e.RUB&&(t.price.RUB="RUB"!=(null===(r=wb.currencies)||void 0===r?void 0:r.selected)?$.views.helpers.priceFromRub(t.price.RUB/100,!0):Math.round(t.price.RUB/100))}),e>0){var r=(new Date).setHours(0,0,0,0)/1e3;t.push({dt:r,price:{RUB:e},avoidPriceMargin:!0})}this.renderChartAsync(t.slice(-26))}},e.showPricePoint=function(t){var e;"touchmove"==t.type&&t.preventDefault();var r=t.currentTarget.getBoundingClientRect(),n=r.width,i=r.left,o=this.canvasWidth/n,a=("touchmove"==t.type?t.originalEvent.targetTouches[0].pageX-i:t.offsetX)*o,s=this.charPoint.find(function(t,e,r){var n=Math.max(0,a),i=0==e?t.xCoord:r[e-1].xCoord,o=t.xCoord,s=e==r.length-1?r[r.length-1].xCoord:r[e+1].xCoord;return i+(o-i)/2<=n&&n<=o+(s-o)/2});s&&(null==this.marker&&(this.marker=t.currentTarget.querySelector("circle")),this.currentChartPoint=s,this.marker.dispatchEvent(new CustomEvent("Unshown")),this.marker.setAttribute("cx",s.xCoord),this.marker.setAttribute("cy",s.yCoord),null===(e=this.marker.classList)||void 0===e||e.remove("hide"),this.marker.dispatchEvent(new CustomEvent("Shown")))},e.hidePricePoint=function(){var t,e,r;null===(t=this.marker)||void 0===t||null===(e=t.classList)||void 0===e||e.add("hide"),null===(r=this.marker)||void 0===r||r.dispatchEvent(new CustomEvent("Unshown"))},e.toggleChart=function(){var t;if("m"==wb.settings.displayMode)if(this.toggleProperty("hideChart"),this.hideChart)null===(t=this.marker)||void 0===t||t.dispatchEvent(new CustomEvent("Unshown"));else if(this.marker){var e;null===(e=this.marker.classList)||void 0===e||e.remove("hide"),this.marker.dispatchEvent(new CustomEvent("Shown"))}},e._buildPoints=function(t,e){return t.map(function(t){return{dt:t.dt,price:t.price.RUB*(t.avoidPriceMargin?1:e)}})},e._getSettings=function(t){var e=t.reduce(function(t,e){return e.price<t.min&&(t.min=e.price),e.price>t.max&&(t.max=e.price),t},{min:1/0,max:-1/0}),r=e.max-e.min,n=t[t.length-1].dt-t[0].dt,i=r/.6,o=i>0?this.canvasHeigth/i:.01,a=this.canvasWidth/n,s=_slicedToArray(t.slice(-2),2),c=s[0].price,u=s[1].price;return{xAxisCoef:a,yAxisCoef:o,medianPrice:(e.max+e.min)/2,startDate:t[0].dt,lastDate:t[t.length-1].dt,minPrice:e.min,maxPrice:e.max,periodDelta:Math.abs(c-u),periodTrend:Math.sign(u-c)}},e._createCharPoints=function(t,e){for(var r=this,n=t.map(function(t){return{xCoord:(t.dt-e.startDate)*e.xAxisCoef,yCoord:r.canvasHeigth*(1-.8*t.price/e.maxPrice),startDate:new Date(1e3*t.dt),price:t.price}}),i=0;i<n.length-1;i++){var o=n[i],a=n[i+1],s={xCoord:o.xCoord+.25*(a.xCoord-o.xCoord),yCoord:o.yCoord},c={xCoord:o.xCoord+.75*(a.xCoord-o.xCoord),yCoord:a.yCoord};o.bezierPoint=[s,c],a.previous=o,o.next=a}return n},e._createDashedBars=function(){var t=[{xCoord:1,yCoord:this.charPoint[0].yCoord}];return t.push({xCoord:this.canvasWidth-1,yCoord:this.charPoint[this.charPoint.length-1].yCoord}),t},e._bezierCoord=function(t,e,r,n,i){var o=1-t;return Math.pow(o,3)*e+3*Math.pow(o,2)*t*r+3*o*Math.pow(t,2)*n+Math.pow(t,3)*i},e._buildCharPath=function(){var t=this,e=[];return this.charPoint.forEach(function(r,n){0==n?e.push("M ".concat(r.xCoord," ").concat(r.yCoord," C ").concat(r.bezierPoint[0].xCoord," ").concat(r.bezierPoint[0].yCoord,", ").concat(r.bezierPoint[1].xCoord," ").concat(r.bezierPoint[1].yCoord)):n==t.charPoint.length-1?e.push("".concat(r.xCoord," ").concat(r.yCoord)):e.push("".concat(r.xCoord," ").concat(r.yCoord,", ").concat(r.bezierPoint[0].xCoord," ").concat(r.bezierPoint[0].yCoord,", ").concat(r.bezierPoint[1].xCoord," ").concat(r.bezierPoint[1].yCoord))}),e.join(", ")},e._bindEvents=function(){this.$eventBus.addEventListener("ProductColorChanged",this.onColorChanged),this.$eventBus.addEventListener("ProductChanged",this.onColorChanged)},e._unbindEvents=function(){this.$eventBus.removeEventListener("ProductColorChanged",this.onColorChanged),this.$eventBus.removeEventListener("ProductChanged",this.onColorChanged)},_createClass(t,[{key:"template",get:function(){return t.template}},{key:"chartEnable",get:function(){var t,e,r;return null!==(t=null===(e=wb.global.settings)||void 0===e?void 0:null===(r=e.switches)||void 0===r?void 0:r.enablePriceHistoryChart)&&void 0!==t&&t}},{key:"canvasWidth",get:function(){return 1200}},{key:"canvasHeigth",get:function(){return this.$isDesktop?156:330}},{key:"minPrice",get:function(){return this.settings.minPrice}},{key:"maxPrice",get:function(){return this.settings.maxPrice}},{key:"periodChange",get:function(){return this.settings.periodDelta}},{key:"periodTrend",get:function(){return this.settings.periodTrend}},{key:"startDate",get:function(){var t=new Date(1e3*this.settings.startDate);return t.setDate(t.getDate()-7),t}},{key:"lastDate",get:function(){return new Date(1e3*this.settings.lastDate)}},{key:"currentPeriod",get:function(){var t=this;return{get startDate(){var e,r=null===(e=t.currentChartPoint.previous)||void 0===e?void 0:e.startDate;return r||(r=new Date(+t.currentChartPoint.startDate)).setDate(t.currentChartPoint.startDate.getDate()-7),r},get lastDate(){return t.currentChartPoint.startDate},get price(){return t.currentChartPoint.price}}}}]),t}();window.__spaModuleManager__.register("priceHistoryChart",t)}();

},{}]},{},[1]);

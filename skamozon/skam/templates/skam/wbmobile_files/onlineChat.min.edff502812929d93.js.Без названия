(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";function asyncGeneratorStep(e,t,r,n,i,s,o){try{var a=e[s](o),l=a.value}catch(e){return void r(e)}a.done?t(l):Promise.resolve(l).then(n,i)}function _asyncToGenerator(e){return function(){var t=this,r=arguments;return new Promise(function(n,i){var s=e.apply(t,r);function o(e){asyncGeneratorStep(s,n,i,o,a,"next",e)}function a(e){asyncGeneratorStep(s,n,i,o,a,"throw",e)}o(void 0)})}}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}!function(){var e=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,t={"89504e47":"image/png",ffd8ffe0:"image/jpeg",ffd8ffe1:"image/jpeg",ffd8ffe2:"image/jpeg",ffd8ffe3:"image/jpeg",ffd8ffe8:"image/jpeg",25504446:"application/pdf"},r=function(){function r(e,t){this.isAuth=e,this.uid=t,this.uploading=!1,this.uploadingImg=!1,this.tooltipTag=!!$.views.tags.tooltip,this.history=[],this.currentPoll=null,this.pollId=null,this.onSubmit=this.onSubmit.bind(this),this.onFileChange=this.onFileChange.bind(this),this.onRatingClick=this.onRatingClick.bind(this),this._longPoll=this._longPoll.bind(this),this.baseUrl="by"==wb.settings.currentLocale?"https://chat-prod.wildberries.by":"https://chat-prod.wildberries.ru",this.filesUrl="https://rcvfiles.wildberries.ru"}r._stripHtml=function(e){return(new DOMParser).parseFromString(e,"text/html").body.textContent||""};var n=r.prototype;return n._getEndpoint=function(){return"api/support/".concat(this.isAuth?"v2/client":"v1/unauth")},n.init=function(e,t){return this._bindEvents(),this.setScrollable(e.querySelector(".chat__scroll")),this.chat=t,this},n.setScrollable=function(e){this.scrollable=e},n.initAsync=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._getHistoryAsync();case 3:return t=e.sent,this.history=t,this._longPoll(),e.abrupt("return",!0);case 9:return e.prev=9,e.t0=e.catch(0),console.error(e.t0),e.abrupt("return",!1);case 13:case"end":return e.stop()}},e,this,[[0,9]])}));return function(){return e.apply(this,arguments)}}(),n.stopChat=function(){this.currentPoll&&this.currentPoll.abort(),clearTimeout(this.pollId),this.currentPoll=null},n.refreshAsync=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return $.observable(this.history).refresh([]),this.stopChat(),e.next=4,this._getHistoryAsync();case 4:t=e.sent,$.observable(this.history).refresh(t||[]),this.scrollToBottom(),this._longPoll();case 8:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}(),n.onSubmit=function(){var e=this;if(0===this.text.trim().length)return!1;var t=r._stripHtml(this.text);return this.$helper.debounce(this._sendMessage({msg_text:t}).then(function(e){return e.json()}).then(function(r){e.currentPoll||(e._refreshHistory([{message_id:r.message_id,msg_text:t,dt:new Date}]),e.pollId=setTimeout(e._longPoll,100)),$.observable(e).setProperty({text:""}),document.querySelector(".j-chat-textarea").style.height="auto"}),100),!1},n.onFileChange=function(e){var t=this;$.observable(this).setProperty({uploading:!0});var r=e.currentTarget,n=r.files[0];return r.value="",this._onFileChangeAsync(n).finally(function(e){$.observable(t).setProperty({uploading:!1,uploadingImg:!1})})},n.onRatingClick=function(e){var t=this;this.Rating||this.$httpClient.fetchJSON("onlinechat/rating",{method:"POST",body:new URLSearchParams({rating:e})}).then(function(){$.observable(t).setProperty({Rating:e})})},n.onKeyPress=function(e,t){13!==e.which||e.shiftKey||(e.target.form.dispatchEvent(new Event("submit",{cancelable:!0})),e.preventDefault())},n.getFileName=function(e){return e.substring(e.lastIndexOf("/")+1)},n.linkify=function(t){return(t=r._stripHtml(t)).indexOf("http")<0?t:t.replace(e,function(e){return'<a class="link" target="_blank" href="'.concat(e,'">ссылка</a>')})},n.isEmpty=function(e){return!e||""===e.trim()},n.scrollToBottom=function(){this.scrollable&&(this.scrollable.scrollTop=this.scrollable.scrollHeight-this.scrollable.clientHeight)},n._bindEvents=function(){document.querySelector(".j-chat-textarea").addEventListener("input",function(){this.style.height="auto";var e=this.scrollHeight;this.style.height=e+"px"})},n._getHistoryAsync=function(e){var t,r=new URL(this.getMessagesUrl);return e&&(r.search=new URLSearchParams(e).toString()),fetch(r.toString(),Object.assign({signal:null===(t=this.currentPoll)||void 0===t?void 0:t.signal},this._requestOptions)).then(function(e){if(e.ok)return e.json();throw new Error(e.statusText)})},n._longPoll=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.history.length>0){e.next=2;break}return e.abrupt("return");case 2:return this.currentPoll=new AbortController,e.prev=3,e.next=6,this._getHistoryAsync({message_id:(null===(t=this.lastMessage)||void 0===t?void 0:t.message_id)+1,lp:!0,delay:50});case 6:n=e.sent,this._refreshHistory(n),Array.isArray(n)&&n.length>0&&(null===(r=this.lastMessage)||void 0===r?void 0:r.is_inside)&&!this.chat.isVisible()&&(this.$eventBus.dispatchEvent(new CustomEvent("UpdateOnlineChatSettings",{detail:[["unread",!0]]})),this.$eventBus.dispatchEvent(new CustomEvent("OnlineChatShowUnread"))),this.pollId=setTimeout(this._longPoll.bind(this),100),e.next=17;break;case 13:if(e.prev=13,e.t0=e.catch(3),"AbortError"===e.t0.name){e.next=17;break}throw e.t0;case 17:case"end":return e.stop()}},e,this,[[3,13]])}));return function(){return e.apply(this,arguments)}}(),n._refreshHistory=function(e){Array.isArray(e)&&($.observable(this.history).insert(e),this.scrollToBottom())},n._sendMessage=function(e){return fetch(this.sendMessageUrl,Object.assign({method:"POST",body:JSON.stringify(e)},this._requestOptions))},n._sendFile=function(e){var t=new FormData;return t.append("file",e),fetch(this.fileUploadUrl,{method:"POST",processData:!1,body:t,credentials:"omit",cache:"no-cache"}).then(function(e){if(e.ok)return e.text();throw new Error("wrong status")})},n._onFileChangeAsync=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,i,s,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return(r=t&&"image"===t.type.split("/")[0])&&($.observable(this).setProperty({uploadingImg:!0}),this.scrollToBottom()),e.next=4,this._isFileSupported(t);case 4:if(e.sent){e.next=7;break}return wb.popup.renderModalError("Файл не поддерживается"),e.abrupt("return");case 7:if(!(t.size>=10485760)){e.next=10;break}return wb.popup.renderModalError("Слишком большой файл"),e.abrupt("return");case 10:return n={},e.prev=11,e.next=14,this._sendFile(t);case 14:i=e.sent,r?n.image_url=i:n.file_url=i,e.next=23;break;case 18:return e.prev=18,e.t0=e.catch(11),console.error(e.t0),wb.popup.renderModalError("Не удалось загрузить файл"),e.abrupt("return");case 23:return e.prev=23,e.next=26,this._sendMessage(n);case 26:return s=e.sent,e.next=29,s.json();case 29:if(o=e.sent,!this.currentPoll){e.next=32;break}return e.abrupt("return");case 32:this._refreshHistory([{message_id:o.message_id,image_url:n.image_url,file_url:n.file_url,dt:new Date}]),this.pollId=setTimeout(this._longPoll,100),e.next=41;break;case 36:return e.prev=36,e.t1=e.catch(23),console.error(e.t1),wb.popup.renderModalError("Не удалось отправить сообщение"),e.abrupt("return");case 41:case"end":return e.stop()}},e,this,[[11,18],[23,36]])}));return function(t){return e.apply(this,arguments)}}(),n._isFileSupported=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var n,i,s,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.$moduleLoader.loadModuleAsync("promisifiedFileReader");case 2:return n=e.sent,e.next=5,(new n).readAsArrayBuffer(r.slice(0,4));case 5:return i=e.sent,s=new Uint8Array(i),o=s.reduce(function(e,t){return e+t.toString(16)},""),e.abrupt("return",!!t[o]);case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}(),_createClass(r,[{key:"template",get:function(){return r.template}},{key:"getMessagesUrl",get:function(){return"".concat(this.baseUrl,"/").concat(this._getEndpoint(),"/messages")}},{key:"sendMessageUrl",get:function(){return"".concat(this.baseUrl,"/").concat(this._getEndpoint(),"/send")}},{key:"fileUploadUrl",get:function(){return"".concat(this.filesUrl,"/upload")}},{key:"lastMessage",get:function(){return this.history[this.history.length-1]}},{key:"_requestOptions",get:function(){var e={credentials:this.isAuth?"include":"omit",cache:"no-cache",headers:{locale:wb.settings.currentLocale}};return this.isAuth||(e.headers.BasketUID=this.uid),e}}]),r}();window.__spaModuleManager__.register("onlineChat",r)}();

},{}]},{},[1]);
